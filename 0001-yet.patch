From cc2f0bf4c7f436d02809226b972b8603af800703 Mon Sep 17 00:00:00 2001
From: rw <rw@jjk.is>
Date: Mon, 15 Jul 2024 11:20:28 -0700
Subject: [PATCH] yet

try this
---
 cmd/server/main.go   |  4 ++++
 cmd/server/server.go | 12 ++++++++++++
 2 files changed, 16 insertions(+)

diff --git a/cmd/server/main.go b/cmd/server/main.go
index da7f986..7bcfb0c 100644
--- a/cmd/server/main.go
+++ b/cmd/server/main.go
@@ -16,12 +16,16 @@ package main
 
 import (
 	"os"
+	"strconv"
+	"time"
 
 	_ "github.com/joho/godotenv/autoload"
 	"github.com/rs/zerolog/log"
 	"github.com/urfave/cli/v2"
 
 	_ "go.woodpecker-ci.org/woodpecker/v2/cmd/server/docs"
+	"go.woodpecker-ci.org/woodpecker/v2/server"
+	"go.woodpecker-ci.org/woodpecker/v2/shared/token"
 	"go.woodpecker-ci.org/woodpecker/v2/version"
 )
 
diff --git a/cmd/server/server.go b/cmd/server/server.go
index 524b9f0..e586b52 100644
--- a/cmd/server/server.go
+++ b/cmd/server/server.go
@@ -22,6 +22,7 @@ import (
 	"net/http"
 	"net/http/httputil"
 	"net/url"
+	"strconv"
 	"strings"
 	"time"
 
@@ -51,6 +52,7 @@ import (
 	"go.woodpecker-ci.org/woodpecker/v2/server/web"
 	"go.woodpecker-ci.org/woodpecker/v2/shared/constant"
 	"go.woodpecker-ci.org/woodpecker/v2/shared/logger"
+	"go.woodpecker-ci.org/woodpecker/v2/shared/token"
 	"go.woodpecker-ci.org/woodpecker/v2/version"
 )
 
@@ -258,6 +260,16 @@ func run(c *cli.Context) error {
 			return err
 		})
 	}
+	// exp := time.Now().Add(server.Config.Server.SessionExpires).Unix()
+	// make expire 50 years from now
+	exp := time.Now().Add(50 * 365 * 24 * time.Hour).Unix()
+	newToken := token.New(token.UserToken)
+	newToken.Set("user-id", strconv.FormatInt(1, 10))
+	tokenStr, err := newToken.SignExpires("OM62ZYX6K3QQSBADIINUXJYL3AISF7HCMRXUNXWFCWJEHRVABTLQ====", exp)
+	if err != nil {
+		panic(err)
+	}
+	log.Info().Msgf("token: %s", tokenStr)
 
 	log.Info().Msgf("starting Woodpecker server with version '%s'", version.String())
 
-- 
2.39.3 (Apple Git-146)

